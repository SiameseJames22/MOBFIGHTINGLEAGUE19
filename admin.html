<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mob Fighting League</title>
  <style>
    :root { --bg:#0b0f14; --card:#121a24; --text:#e7eefc; --muted:#98a6bf; --accent:#4aa3ff; --danger:#ff4a4a; --ok:#3dff8b; }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    body{margin:0;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:10;background:rgba(11,15,20,.9);backdrop-filter: blur(10px);border-bottom:1px solid rgba(255,255,255,.08)}
    .wrap{max-width:1100px;margin:0 auto;padding:14px 16px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    nav a{color:var(--muted);text-decoration:none;margin-right:12px}
    nav a.active{color:var(--text)}
    .btn{border:1px solid rgba(255,255,255,.14);background:transparent;color:var(--text);padding:8px 10px;border-radius:12px;cursor:pointer}
    .btn.primary{background:var(--accent);border-color:transparent;color:#06111f;font-weight:800}
    .btn.danger{background:var(--danger);border-color:transparent;color:#210000;font-weight:800}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:18px;padding:14px}
    .grid{display:grid;gap:12px}
    .grid.two{grid-template-columns:1fr;}
    @media(min-width:980px){ .grid.two{grid-template-columns: 1.2fr .8fr;} }
    h1,h2,h3{margin:0 0 10px 0}
    .muted{color:var(--muted)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 8px;border-bottom:1px solid rgba(255,255,255,.08);text-align:left;font-size:14px}
    th{color:var(--muted);font-weight:600}
    .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid rgba(255,255,255,.12);padding:6px 10px;border-radius:999px;color:var(--muted)}
    input,select,textarea{width:100%;padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.14);background:#0e1520;color:var(--text)}
    textarea{min-height:90px;resize:vertical}
    label{font-size:12px;color:var(--muted)}
    .stack{display:grid;gap:8px}
    .small{font-size:12px}
    .right{margin-left:auto}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .banner{border:1px solid rgba(255,255,255,.12);background:rgba(255,74,74,.12);padding:10px 12px;border-radius:14px}
    .okbanner{background:rgba(61,255,139,.10)}
    .tag{display:inline-flex;align-items:center;border:1px solid rgba(255,255,255,.14);padding:4px 8px;border-radius:999px;font-size:12px;color:var(--muted)}
    .hr{height:1px;background:rgba(255,255,255,.08);margin:10px 0}
  </style>
</head>
<body>
<header>
  <div class="wrap row">
    <div class="row" style="gap:12px;">
      <strong>Mob Fighting League</strong>
      <span class="pill small">Season: <span class="mono" id="seasonLabel">—</span></span>
    </div>

    <nav class="right">
      <a href="./index.html" data-route="table">Table</a>
      <a href="./live.html" data-route="live">Live Matches</a>
      <a href="./clips.html" data-route="clips">Clips</a>
      <a href="./auth.html" data-route="auth">Login</a>
      <a href="./admin.html" data-route="admin" id="adminNav" style="display:none;">Admin</a>
    </nav>

    <div class="row">
      <span id="userLabel" class="muted small">Not signed in</span>
      <button id="logoutBtn" class="btn" style="display:none;">Sign out</button>
    </div>
  </div>
</header>
<main class="wrap">
  <div id="leagueOver" class="banner" style="display:none;margin-bottom:12px;">
    <strong>League Over!</strong>
    <div class="muted small">This season is closed (July 17). Come back next February to start a new league.</div>
  </div>

  <div class="grid two">
    <section class="card" id="page"></section>

    <aside class="card">
      <h3>Notifications</h3>
      <div class="muted small" style="margin-bottom:10px;">Updates appear here whenever scores change or matches end.</div>
      <div id="notifList" class="stack"></div>
    </aside>
  </div>
</main>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged,
    createUserWithEmailAndPassword, signInWithEmailAndPassword
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    getFirestore, doc, getDoc, setDoc, updateDoc, addDoc, deleteDoc,
    collection, query, orderBy, onSnapshot, getDocs, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";

  // ======= EDIT THESE TWO =======
  const firebaseConfig = FIREBASE_CONFIG_HERE; // paste your Firebase config object here
  const ADMIN_UID = "ADMIN_UID_HERE";          // paste your UID here (Firebase Auth -> Users)
  // ==============================

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  const $ = (id) => document.getElementById(id);
  const escapeHtml = (str) => String(str).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const slug = (s) => s.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,"").slice(0,40) || ("team-"+Math.random().toString(16).slice(2));
  const fmtDate = (d) => d.toISOString().slice(0,10);

  function getSeasonInfo(now = new Date()) {
    const year = now.getUTCFullYear();
    const startThisYear = new Date(Date.UTC(year, 1, 11, 0, 0, 0));
    const seasonYear = (now < startThisYear) ? year - 1 : year;
    const start = new Date(Date.UTC(seasonYear, 1, 11, 0, 0, 0));
    const end = new Date(Date.UTC(seasonYear, 6, 17, 23, 59, 59));
    const isOver = now > end;
    return { seasonYear, start, end, isOver };
  }

  async function addNotification(text){
    await addDoc(collection(db, "notifications"), { text, createdAt: serverTimestamp() });
  }

  async function fetchTeams(){
    const snap = await getDocs(collection(db,"teams"));
    const list = snap.docs.map(d=>({id:d.id, ...d.data()}));
    list.sort((a,b)=>
      (b.points||0)-(a.points||0) ||
      ((b.gd ?? ((b.gf||0)-(b.ga||0))) - (a.gd ?? ((a.gf||0)-(a.ga||0)))) ||
      (b.gf||0)-(a.gf||0) ||
      String(a.name||"").localeCompare(String(b.name||""))
    );
    return list;
  }

  async function fetchTeamsMap(){
    const teams = await fetchTeams();
    return new Map(teams.map(t=>[t.id,t]));
  }

  async function fetchMatches(statuses){
    const snap = await getDocs(collection(db,"matches"));
    const list = snap.docs.map(d=>({id:d.id, ...d.data()}));
    return list.filter(m=>statuses.includes(m.status))
      .sort((a,b)=> (b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));
  }

  async function applyResultToTable(homeId, awayId, homeScore, awayScore){
    const href = doc(db,"teams",homeId);
    const aref = doc(db,"teams",awayId);
    const [hsnap, asnap] = await Promise.all([getDoc(href), getDoc(aref)]);
    if (!hsnap.exists() || !asnap.exists()) return;

    const h = hsnap.data();
    const a = asnap.data();

    const hPlayed = (h.played||0)+1;
    const aPlayed = (a.played||0)+1;

    let hWon=h.won||0, hDraw=h.drawn||0, hLost=h.lost||0, hPts=h.points||0;
    let aWon=a.won||0, aDraw=a.drawn||0, aLost=a.lost||0, aPts=a.points||0;

    if (homeScore > awayScore) { hWon++; aLost++; hPts += 3; }
    else if (homeScore < awayScore) { aWon++; hLost++; aPts += 3; }
    else { hDraw++; aDraw++; hPts += 1; aPts += 1; }

    const hGf=(h.gf||0)+homeScore, hGa=(h.ga||0)+awayScore;
    const aGf=(a.gf||0)+awayScore, aGa=(a.ga||0)+homeScore;

    await Promise.all([
      updateDoc(href, { played:hPlayed, won:hWon, drawn:hDraw, lost:hLost, gf:hGf, ga:hGa, gd:hGf-hGa, points:hPts }),
      updateDoc(aref, { played:aPlayed, won:aWon, drawn:aDraw, lost:aLost, gf:aGf, ga:aGa, gd:aGf-aGa, points:aPts })
    ]);
  }

  // Global topbar state
  onSnapshot(query(collection(db, "notifications"), orderBy("createdAt","desc")), (snap) => {
    $("notifList").innerHTML = "";
    snap.docs.slice(0, 20).forEach(d => {
      const n = d.data();
      const div = document.createElement("div");
      div.className = "card";
      div.style.padding = "10px";
      div.innerHTML = `<div>${escapeHtml(n.text || "")}</div>
                       <div class="muted small">${n.createdAt?.toDate ? n.createdAt.toDate().toLocaleString() : ""}</div>`;
      $("notifList").appendChild(div);
    });
  });

  onAuthStateChanged(auth, async (user) => {
    const { seasonYear, start, end, isOver } = getSeasonInfo(new Date());
    $("seasonLabel").textContent = `${seasonYear} (${fmtDate(start)} → ${fmtDate(end)})`;
    $("leagueOver").style.display = isOver ? "" : "none";

    const path = location.pathname.split("/").pop() || "index.html";
    document.querySelectorAll('nav a[data-route]').forEach(a => a.classList.remove("active"));
    const map = { "index.html":"table", "live.html":"live", "clips.html":"clips", "auth.html":"auth", "admin.html":"admin" };
    const activeKey = map[path];
    const activeLink = document.querySelector(`nav a[data-route="${activeKey}"]`);
    if (activeLink) activeLink.classList.add("active");

    if (!user) {
      $("userLabel").textContent = "Not signed in";
      $("logoutBtn").style.display = "none";
      $("adminNav").style.display = "none";
      window.__user = null;
      await renderPage();
      return;
    }

    window.__user = user;

    $("userLabel").textContent = `${user.displayName || "User"} • ${user.email || ""}`;
    $("logoutBtn").style.display = "";
    $("logoutBtn").onclick = async () => { await signOut(auth); location.href = "./auth.html"; };

    $("adminNav").style.display = (user.uid === ADMIN_UID) ? "" : "none";

    // Ensure /users/{uid} exists
    const uref = doc(db, "users", user.uid);
    const usnap = await getDoc(uref);
    if (!usnap.exists()) {
      await setDoc(uref, {
        displayName: user.displayName || "",
        email: user.email || "",
        favouriteTeam: "",
        createdAt: serverTimestamp()
      });
    }
    await renderPage();
  });

  
  async function renderPage(){
    const user = window.__user;
    const isAdmin = user && user.uid === ADMIN_UID;

    if (!isAdmin) {
      $("page").innerHTML = `
        <h2>Admin</h2>
        <div class="banner"><strong>Access denied.</strong><div class="muted small">Only the admin account can edit teams, matches, scores, and clips.</div></div>
        <div style="height:10px"></div>
        <div class="muted small">Your UID: <span class="mono">${escapeHtml(user?.uid || "—")}</span></div>
        <div class="muted small">If you're the admin: paste your UID into <span class="mono">ADMIN_UID</span> in every HTML.</div>
      `;
      return;
    }

    const teams = await fetchTeams();

    $("page").innerHTML = `
      <h2>Admin</h2>
      <div class="muted small">Signed in as: <span class="mono">${escapeHtml(user.email || user.uid)}</span></div>

      <div class="hr"></div>

      <div class="card">
        <h3>Bulk add teams</h3>
        <div class="muted small">Paste one team per line. (Alphabetical is fine.)</div>
        <div style="height:8px"></div>
        <textarea id="bulkTeams" placeholder="Chickens&#10;Cows&#10;Creepers..."></textarea>
        <div class="row" style="margin-top:10px;">
          <button class="btn primary" id="bulkAddBtn">Add / Update teams</button>
          <span class="muted small" id="bulkMsg"></span>
        </div>
      </div>

      <div style="height:12px"></div>

      <div class="card">
        <h3>Add single team</h3>
        <div class="row">
          <div style="flex:1">
            <label>Team name</label>
            <input id="teamName" placeholder="e.g. Iron Golems">
          </div>
          <div style="align-self:end">
            <button class="btn primary" id="addTeamBtn">Add</button>
          </div>
        </div>
      </div>

      <div style="height:12px"></div>

      <div class="card">
        <h3>Current teams</h3>
        <div class="stack" id="teamList"></div>
      </div>
    `;

    // Prefill with your 16 teams, alphabetical
    $("bulkTeams").value =
`Chickens
Cows
Creepers
Endermens
Endermites
Feesh
Foxes
Iron Golems
Ocelots
Pillagers
Pigs
Skeletons
Snowmen
Villagers
Wolves
Zombies`;

    const renderTeams = async () => {
      const fresh = await fetchTeams();
      const list = $("teamList");
      list.innerHTML = "";
      fresh.forEach(t=>{
        const div = document.createElement("div");
        div.className = "row";
        div.innerHTML = `
          <div style="flex:1"><strong>${escapeHtml(t.name)}</strong></div>
          <span class="tag">Pts ${t.points||0}</span>
          <button class="btn danger" data-del="${t.id}">Remove</button>
        `;
        list.appendChild(div);
      });

      list.querySelectorAll("button[data-del]").forEach(btn=>{
        btn.onclick = async ()=>{
          const id = btn.getAttribute("data-del");
          await deleteDoc(doc(db,"teams",id));
          await addNotification("Team removed.");
          await renderTeams();
        };
      });
    };

    await renderTeams();

    $("addTeamBtn").onclick = async () => {
      const name = $("teamName").value.trim();
      if (!name) return;
      const id = slug(name);
      await setDoc(doc(db,"teams",id), {
        name, played:0, won:0, drawn:0, lost:0, gf:0, ga:0, gd:0, points:0,
        createdAt: serverTimestamp()
      }, { merge:true });
      $("teamName").value = "";
      await addNotification(`Team added: ${name}`);
      await renderTeams();
    };

    $("bulkAddBtn").onclick = async () => {
      $("bulkMsg").textContent = "Working…";
      const lines = $("bulkTeams").value.split("\n").map(s=>s.trim()).filter(Boolean);
      for (const name of lines) {
        const id = slug(name);
        await setDoc(doc(db,"teams",id), {
          name, played:0, won:0, drawn:0, lost:0, gf:0, ga:0, gd:0, points:0,
          createdAt: serverTimestamp()
        }, { merge:true });
      }
      await addNotification(`Bulk teams updated (${lines.length}).`);
      $("bulkMsg").textContent = `Added/updated ${lines.length} teams.`;
      await renderTeams();
    };
  }

</script>
</body>
</html>
